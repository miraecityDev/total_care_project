<!DOCTYPE html>
<!--suppress ALL -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Miraecity Totalcare Robot</title>
    <link id="favicon" rel="icon" type="image/x-icon" href="{{ url_for('static', path='logo.ico') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', path='/css/styles.css?v=1') }}">
</head>
<body style="background-color:#ffffff;">
    <p style="font-size:25px;">
        <u style="color: #4261e5; margin-left: 70%;">{{username}}</u>
        <button id="btn_logout" class="custom-btn btn-2" onclick="Logout()"><span>ë¡œê·¸ ì•„ì›ƒ</span></button>
    </p>
    <div id="head">
      <h1>êµëŸ‰ í•˜ë©´ ì ê²€ìš© ë¡œë³´ìº  <br> ìš´ìš© ì‹œìŠ¤í…œ</h1>
    </div>
    <div id="control">
        <table border='1'>
            <tr id="robot_head" class="tr-1">
                <th> ğŸ“ ìœ„ ì¹˜ </th>
                <th> ğŸš‹ ë¡œë´‡ ìƒíƒœ </th>
                <th> ğŸ’¨ ì†ë„(m/s) </th>
                <th> ğŸš© ë¡œë´‡ ìœ„ì¹˜(M) </th>
                <th> ğŸ”‹ ë°°í„°ë¦¬(%) </th>
            </tr>
            <tr id="robot_head">
                <th id="robot_place"> - </th>
                <th id="robot_status"> - </th>
                <th id="robot_speed"> - </th>
                <th id="robot_position"> - </th>
                <th id="robot_battery"> - </th>
            </tr>
        </table>
        <p style="font-size:25px;">âœ” ê¸° ì§€
<!--            <select id='place' style="font-size:25px; height:50px">-->
<!--                <option value = "ì„œìš¸ ì‹ ì • ì°¨ëŸ‰">ì„œìš¸ ì‹ ì • ì°¨ëŸ‰</option>-->
<!--                <option value = "ì„œìš¸ ì°½ë™ ì°¨ëŸ‰">ì„œìš¸ ì°½ë™ ì°¨ëŸ‰</option>-->
<!--                <option value = "ì„œìš¸ ìˆ˜ì„œ ì°¨ëŸ‰">ì„œìš¸ ìˆ˜ì„œ ì°¨ëŸ‰</option>-->
<!--                <option value = ""></option>-->
<!--                <option value = ""></option>-->
<!--                <option value = ""></option>-->
<!--            </select>-->
            <input id='place' type='text' value="ì°½ë™ ì°¨ëŸ‰ ê¸°ì§€" autocomplete="on" style="font-size:25px; width:200px; height:50px;"></input>
            <button id="btn_place" class="custom-btn btn-1" style="font-size:18px;" onclick=Robot_Place()>ì„  íƒ</button>
            <br>âœ” ìœ„ ì¹˜
            <input id='location' style="font-size:25px; margin-left: 10px" type='number' min='0' max='10000' value='100' onchange='SetLocation()' placeholder="0 - 10000"/>M
            <button id="btn_location" class="custom-btn btn-1" style="font-size:18px;" onclick=Robot_Control("goto")>ìœ„ì¹˜ ì´ë™</button>
            <button id="btn_target" class="custom-btn btn-1" style="font-size:18px;" onclick=Robot_Control("target")>íƒ€ê²Ÿ ì´ë™</button>
            <br>âœ” ì† ë„
            <select id='velocity' style="font-size:25px;">
                <option value = "0.1">0.1</option>
                <option value = "0.2">0.2</option>
                <option value = "0.3">0.3</option>
                <option value = "0.4">0.4</option>
                <option value = "0.5" selected>0.5</option>
                <option value = "0.6">0.6</option>
                <option value = "0.7" >0.7</option>
                <option value = "0.8">0.8</option>
                <option value = "0.9">0.9</option>
                <option value = "1.0">1.0</option>
            </select>m/s
            <button id="btn_velocity" class="custom-btn btn-1" style="font-size:18px;" onclick=Robot_Speed()>ì†ë„ ë³€ê²½</button>
            <br>
            <button id="btn_backward" class="custom-btn btn-3" style="font-size:18px;" onclick=Robot_Control("backward")><span>ğŸ”™í›„ì§„</span></button>
            <button id="btn_stop" class="custom-btn btn-7" style="font-size:18px;" onclick=Robot_Control("stop")><span>â¹ï¸ì •ì§€</span></button>
            <button id="btn_forward" class="custom-btn btn-3" style="font-size:18px;" onclick=Robot_Control("forward")><span>ğŸ”œì „ì§„</span></button>
            <br>âœ” ì¡° ëª…
            <select id='led' style="font-size:25px;">
                <option value = "ALL" selected>ALL</option>
                <option value = "ch1">LED1</option>
                <option value = "ch2">LED2</option>
                <option value = "ch3">LED3</option>
                <option value = "ch4">LED4</option>
            </select>
            <font size = 5 id = "slider_value_view">0</font>
            <input id="input_led" oninput = 'ShowSliderValue(this.value)'  type = "range" min='0' max='250' step='10' value='0'>
            <button id="btn_led" class="custom-btn btn-5" style="font-size:18px;" onclick=Robot_LedController()><span>ì  ìš©</span></button>
        </p>
<!--        <h1>ğŸ“· Robot Cam</h1>-->
        <div style="display: flex; justify-content: center;">
<!--            <img style="display: block;" src="http://223.171.146.199:5005/stream" width="480" height="320" onclick="openImage()">-->
            <img style="display: block;" src="http://218.54.201.186:5005/stream" width="480" height="320" onclick="openImage()">
            <div style="display: flex; flex-direction: column; justify-content: center; margin-left: 16px;">
                <p>âœ” PTZ ì† ë„
                  <select id="ptz_speed" style="font-size: 25px;">
                    <option value="slow" selected>Slow</option>
                    <option value="medium">Medium</option>
                    <option value="fast">Fast</option>
                  </select>
                </p>
                <div style="display: flex; justify-content: center;">
                <button id="btn_up" class="custom-btn btn-4" style="color:black; font-size:18px; margin: 8px 0;" onclick="PTZ_Control('up')"><span>â¬†ï¸</span></button>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <button id="btn_left" class="custom-btn btn-4" style="color:black; font-size:18px; margin-right: 8px;" onclick="PTZ_Control('left')"><span>â¬…ï¸</span></button>
                  <button id="btn_right" class="custom-btn btn-4" style="color:black; font-size:18px; margin-left: 8px;" onclick="PTZ_Control('right')"><span>â¡ï¸</span></button>
                </div>
                <div style="display: flex; justify-content: center;">
                <button id="btn_down" class="custom-btn btn-4" style="color:black; font-size:18px; margin: 8px 0;" onclick="PTZ_Control('down')"><span>â¬‡ï¸</span></button>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <button id="btn_zoomup" class="custom-btn btn-4" style="color:black; font-size:18px; margin-right: 8px;" onclick="PTZ_Control('zoom_up')"><span>ğŸ”+</span></button>
                  <button id="btn_zoomdown" class="custom-btn btn-4" style="color:black; font-size:18px; margin-left: 8px;" onclick="PTZ_Control('zoom_down')"><span>ğŸ”-</span></button>
                </div>
            </div>
        </div>
    </div>
    <button id="btn_reboot" class="custom-btn btn-9" onclick="showRebootConfirmation()"><span>reboot</span></button>
    <script>
        const request = new XMLHttpRequest();
        const url = "http://localhost:5005/";
        // const url = "http://223.171.146.199:5005/";
        let target_position = 100;
        let robot_status = {};
        const status_path = "status";
        const stream_path = "stream";
        const ptz_path = "ptz";
        const move_path = "move";
        const led_path = "led";
        const reboot_path = "reboot"

        function openImage(){
            window.open(url+stream_path, "_blank")
        }

        function ShowSliderValue(sVal) {
	        var obValueView = document.getElementById("slider_value_view");
	        obValueView.innerHTML = sVal;
        }

        // ë¡œë´‡ ì‘ë‹µ ë°ì´í„° íŒŒì‹±
        function startShowingMessage(elem, url){
            setInterval(async function() {
                const response = await fetch(url);
                const text = await response.text();
                let status = "";
                elem.textContent = JSON.parse(text);
                // console.log(elem.textContent)
                if (elem.textContent["status"] == "forward"){
                    status = "ì „ ì§„";
                }else if (elem.textContent["status"] == "stop"){
                    status = "ì • ì§€";
                }else if (elem.textContent["status"] == "backward"){
                    status = "í›„ ì§„";
                }else{
                    status = "-";
                }
                document.getElementById("robot_place").innerHTML = elem.textContent["place"];
                document.getElementById("robot_status").innerHTML = status;
                document.getElementById("robot_speed").innerHTML = Math.abs(elem.textContent["speed"]).toFixed(1);
                document.getElementById("robot_position").innerHTML = elem.textContent["position"].toFixed(1);
                document.getElementById("robot_battery").innerHTML = elem.textContent["battery"];
            }, 1000);
        }

        // ë¡œë´‡ ìƒíƒœ ì‘ë‹µ
        setInterval(startShowingMessage(robot_status, url+status_path), 1000);

        // ë¡œë´‡ ì´ë™ ìœ„ì¹˜
        function SetLocation() {
            target_position = document.getElementById('location').value;
            if (target_position < 0 || target_position == null) {
                target_position = 0;
            }
        }

        // ì£¼í–‰ìš© ì¹´ë©”ë¼ PTZ ì œì–´
        function PTZ_Control(command) {
            try {
                const v = document.getElementById("ptz_speed");
                const velocity = v.options[v.selectedIndex].value;
                if (command == "zoom_up") {
                    command = "zoom up";
                } else if (command == "zoom_down") {
                    command = "zoom down";
                }
                const data = {
                    cmdCode: command,
                    cmdTime: velocity
                };
                request.onreadystatechange = function (event) {
                    if (request.readyState == 4 && request.status == 200) {
                        // console.log(request.responseText);
                    }
                }
                // POST ì„¤ì •
                request.open('POST', url + ptz_path, true);

                // POST ì „ì†¡ì‹œ, ë°ì´í„° ì „ë‹¬ì„ ìœ„í•œ ì„¤ì •
                request.setRequestHeader('Content-type', 'application/json');
                request.send(JSON.stringify(data));
            } catch (error) {
                console.error(error);
            }
        }

        // ë¡œë´‡ ì œì–´
        function Robot_Control(command) {
            try {
                var command_value = '';
                if (command == "forward" || command == "backward" || command == "goto" || command == "target"){
                    command_value = target_position;
                } else if (command == "stop"){
                    command_value = '0';
                }
                const data = {
                    cmdCode: command,
                    cmdValue: command_value,
                };
                const request = new XMLHttpRequest();
                request.onreadystatechange = function(event) {
                    if (request.readyState == 4 && request.status == 200){
                        // console.log(request.responseText);
                    }
                }
                // POST ì„¤ì •
                request.open('POST', url+move_path, true);
                // POST ì „ì†¡ì‹œ, ë°ì´í„° ì „ë‹¬ì„ ìœ„í•œ ì„¤ì •
                request.setRequestHeader('Content-type', 'application/json');
                request.send(JSON.stringify(data));
            } catch (error) {
                console.error(error);
            }
        }

        // ë¡œë´‡ ì†ë„ ë³€ê²½
        function Robot_Speed() {
            try {
                const v = document.getElementById("velocity");
                const velocity = v.options[v.selectedIndex].value;
                const data = {
                    cmdCode: "speed",
                    cmdValue: parseFloat(velocity)
                };
                request.onreadystatechange = function (event) {
                    if (request.readyState == 4 && request.status == 200) {
                        // console.log(request.responseText);
                    }
                }
                // POST ì„¤ì •
                request.open('POST', url + move_path, true);

                // POST ì „ì†¡ì‹œ, ë°ì´í„° ì „ë‹¬ì„ ìœ„í•œ ì„¤ì •
                request.setRequestHeader('Content-type', 'application/json');
                request.send(JSON.stringify(data));
            } catch (error) {
                console.error(error);
            }
        }

        // ë¡œë´‡ ì¥ì†Œ ì„ íƒ
        function Robot_Place() {
            try {
                const v = document.getElementById("velocity");
                const velocity = v.options[v.selectedIndex].value;
                const place = document.getElementById("place").value;
                // const place_value = place.options[place.selectedIndex].value;
                const data = {
                    cmdCode: "place",
                    cmdValue: place
                };
                request.onreadystatechange = function (event) {
                    if (request.readyState == 4 && request.status == 200) {
                        // console.log(request.responseText);
                    }
                }
                // POST ì„¤ì •
                request.open('POST', url + move_path, true);

                // POST ì „ì†¡ì‹œ, ë°ì´í„° ì „ë‹¬ì„ ìœ„í•œ ì„¤ì •
                request.setRequestHeader('Content-type', 'application/json');
                request.send(JSON.stringify(data));
            } catch (error) {
                console.error(error);
            }
        }

        // ë¡œë´‡ LED ì œì–´
        function Robot_LedController() {
            try {
                const l = document.getElementById("led");
                const led = l.options[l.selectedIndex].value;
                const val = document.getElementById("input_led").value.padStart(3, '0');
                const data = {
                    cmdCode: led,
                    cmdValue: val
                };
                request.onreadystatechange = function (event) {
                    if (request.readyState == 4 && request.status == 200) {
                        // console.log(request.responseText);
                    }
                }
                // POST ì„¤ì •
                request.open('POST', url + led_path, true);
                // POST ì „ì†¡ì‹œ, ë°ì´í„° ì „ë‹¬ì„ ìœ„í•œ ì„¤ì •
                request.setRequestHeader('Content-type', 'application/json');
                request.send(JSON.stringify(data));
            } catch (error) {
                console.error(error);
            }
        }

        // ë¡œë´‡ í‚¤ë³´ë“œ ì œì–´
        window.addEventListener("keydown", function(event) {
            if (event.key == "ArrowRight") {
                console.log("PTZ Right");
                PTZ_Control("right");
            } else if (event.key == "ArrowLeft") {
                console.log("PTZ Left");
                PTZ_Control("left");
            } else if (event.key == "ArrowUp") {
                console.log("PTZ Up");
                PTZ_Control("up");
            } else if (event.key == "ArrowDown") {
                console.log("PTZ Down");
                PTZ_Control("down");
            } else if (event.key == "z") {
                console.log("PTZ Zoom up");
                PTZ_Control("zoom_up");
            } else if (event.key == "x") {
                console.log("PTZ Zoom down");
                PTZ_Control("zoom_down");
            } else if (event.key == "d") {
                console.log("Move Forward");
                Robot_Control("forward");
            } else if (event.key == "a") {
                console.log("Move Backward");
                Robot_Control("backward");
            } else if (event.key == "s") {
                console.log("Stop");
                Robot_Control("stop");
            } else if (event.key == "m") {
                console.log("Move Location");
                Robot_Control("goto");
            } else if (event.key == "v") {
                console.log("Change Speed");
                Robot_Speed();
            }
        });

        // ë¡œê·¸ì•„ì›ƒ
        function Logout() {
            window.location.href = "/";
        }

        // ë¡œë´‡ ì¬ì‹œì‘
        function showRebootConfirmation() {
            const confirmed = confirm("ë¡œë´‡ì„ ì¬ì‹œì‘ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            if (confirmed) {
                // ì—¬ê¸°ì— ë¡œë´‡ ì¬ì‹œì‘ì„ ìœ„í•œ ì½”ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
                rebootRobot();
            }
        }

        function rebootRobot() {
            // ë¡œë´‡ ì¬ì‹œì‘ì„ ìœ„í•œ ë¡œì§ì„ ì‘ì„±í•©ë‹ˆë‹¤.
            // ì˜ˆë¥¼ ë“¤ì–´, ì„œë²„ë¡œ ì¬ì‹œì‘ ëª…ë ¹ì„ ë³´ë‚´ëŠ” ë“±ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ì´ í•¨ìˆ˜ì—ì„œ ì‹¤ì œë¡œ ë¡œë´‡ì„ ì¬ì‹œì‘í•˜ëŠ” ì½”ë“œë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.
            console.log("ë¡œë´‡ ì¬ì‹œì‘ ì¤‘...");
            try {
                const data = {};
                request.onreadystatechange = function (event) {
                    if (request.readyState == 4 && request.status == 200) {
                        // console.log(request.responseText);
                    }
                }
                // POST ì„¤ì •
                request.open('POST', url + reboot_path, true);
                // POST ì „ì†¡ì‹œ, ë°ì´í„° ì „ë‹¬ì„ ìœ„í•œ ì„¤ì •
                request.setRequestHeader('Content-type', 'application/json');
                request.send(JSON.stringify(data));
            } catch (error) {
                console.error(error);
            }
        }
    </script>
</body>
</html>
